(()=>{"use strict";var t=function(){return t=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},t.apply(this,arguments)},e=function(t){return-1===t.dir.x?"west":1===t.dir.y?"south":1===t.dir.x?"east":-1===t.dir.y?"north":"UNKNOWN"},r=function(t,r,o){var a=e(t)===r;switch(t.type){case 0:return n(o,[]);case 1:return"door";case 2:return"narrow entrance to a "+n(o,[]);case 3:return"way out of the dungeon";case 4:return"portcullis";case 5:return"double doors";case 6:return a?"secret door":"door";case 8:return"broad staircase down";case 9:return"stairwell ".concat(a?"down":"up");default:return console.warn("Unknown door type ".concat(t.type)),"portal"}},n=function(t,e){if("outside"===t)return t;var r,n,a,u=e.filter((function(t){return"secret door"!==t.description})).length;if(o(t))switch(u){case 1:return"alcove";case 2:var c=e.map((function(t){return t.towards}));return n=c[0],a=c[1],"north"===n&&"south"===a||"south"===n&&"north"===a||"east"===n&&"west"===a||"west"===n&&"east"===a?(r=["entranceway","archway"])[Math.floor(Math.random()*r.length)]:"bend";case 3:return"three-way intersection";case 4:return"four-way intersection";default:return"dim passage"}return 1===t.h?2===t.w?"short hallway":t.w>5?"long hallway":"hallway":t.rotunda?"round room":t.w===t.h?"square room":"room"},o=function(t){return 1===t.w&&1===t.h},a=function(t,e){if(!o(t)&&!o(e))return!1;if(!o(e))return a(e,t);var r=t.x,n=t.y,u=t.x+t.w,c=t.y+t.h,i=e.y===n-1,s=e.x===u,d=e.y===c,l=e.x===r-1;return i||d?e.x>=t.x&&e.x<u:!(!s&&!l)&&e.y>=t.y&&e.y<c},u=function(t,e){return t.x>=e.x&&t.x<e.x+e.w&&t.y>=e.y&&t.y<e.y+e.h},c=function(){return c=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},c.apply(this,arguments)},i=function(t,e,r){if(r||2===arguments.length)for(var n,o=0,a=e.length;o<a;o++)!n&&o in e||(n||(n=Array.prototype.slice.call(e,0,o)),n[o]=e[o]);return t.concat(n||Array.prototype.slice.call(e))},s={id:0,turn:0,message:"",end:!1,discovered:[]},d=function(t){return function(e){return 6!==e.type||!e.isFacing||t.discovered.filter((function(e){return e.id===t.id})).some((function(t){return t.towards===e.towards}))}},l=function(t,e,r,n){return new(r||(r=Promise))((function(o,a){function u(t){try{i(n.next(t))}catch(t){a(t)}}function c(t){try{i(n.throw(t))}catch(t){a(t)}}function i(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(u,c)}i((n=n.apply(t,e||[])).next())}))},f=function(t,e){var r,n,o,a,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function c(c){return function(i){return function(c){if(r)throw new TypeError("Generator is already executing.");for(;a&&(a=0,c[0]&&(u=0)),u;)try{if(r=1,n&&(o=2&c[0]?n.return:c[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,c[1])).done)return o;switch(n=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return u.label++,{value:c[1],done:!1};case 5:u.label++,n=c[1],c=[0];continue;case 7:c=u.ops.pop(),u.trys.pop();continue;default:if(!((o=(o=u.trys).length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){u=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){u.label=c[1];break}if(6===c[0]&&u.label<o[1]){u.label=o[1],o=c;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(c);break}o[2]&&u.ops.pop(),u.trys.pop();continue}c=e.call(t,u)}catch(t){c=[6,t],n=0}finally{r=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,i])}}},h=function(t,e,r){if(r||2===arguments.length)for(var n,o=0,a=e.length;o<a;o++)!n&&o in e||(n||(n=Array.prototype.slice.call(e,0,o)),n[o]=e[o]);return t.concat(n||Array.prototype.slice.call(e))},m=function(t,e){var r="dungeons/".concat(t,".svg"),n="dungeons/".concat(t,".json");return e(0),Promise.all([fetch(r),fetch(n)]).then((function(t){return l(void 0,void 0,void 0,(function(){var r,n,o,a;return f(this,(function(u){switch(u.label){case 0:if(r=t[0],n=t[1],!r.ok)throw new Error("Failed to load image file: ".concat(r.status," ").concat(r.statusText));if(!n.ok)throw new Error("Failed to load JSON file: ".concat(n.status," ").concat(n.statusText));return[4,r.text()];case 1:return o=u.sent(),[4,n.json()];case 2:return a=u.sent(),e(100),document.querySelector("section#game").classList.remove("hide"),document.querySelector("section#menu").classList.add("hide"),[2,[o,a]]}}))}))}))},v=document.getElementById("start-button"),w=document.getElementById("progress-bar"),p=function(t){return function(e){return t.value=e}},y=function(t,e){return t.some((function(t){return t===e}))?t:h(h([],t,!0),[e],!1)},g=function(t){return t.split(" ").filter((function(t){return"M"!==t&&"L"!==t&&""!==t})).reduce(y,[]).map((function(t){return t.split(",").map((function(t){return parseInt(t)}))}))},x=function(t){return function(e){var r=document.getElementById("message-scroll"),n=document.createElement("p"),o=e.message.replace(/\n/g,"<br>");if(n.classList.add("message"),n.innerHTML=o,r.appendChild(n),e.error){var a=document.createElement("p");a.classList.add("error"),"syntax"===e.error?a.textContent="Unknown input. Use 'x' to search. Use wasd or the arrow keys to move around.":a.textContent="Unknown error.",r.appendChild(a)}var u=document.createElement("p"),c=e.description.replace(/\n/g,"<br>");u.classList.add("description"),u.innerHTML=c,r.appendChild(u),r.scrollTop=r.scrollHeight;var i,s,d,l,f=e.room;s=(i=function(t){return g(t).reduce((function(t,e){var r=t[0],n=t[1];return[r+e[0],n+e[1]]}),[0,0]).map((function(e){return e/g(t).length}))}(t(f).getAttribute("d")))[0],d=i[1],(l=document.getElementById("avatar")).setAttribute("x","".concat(s+-50)),l.setAttribute("y","".concat(d+-40)),e.exits.forEach((function(e){return t(e.door.id)}))}},b=function(t){var e=t.querySelector("g[transform]").nextElementSibling;e&&(e.remove(),b(t))},E=function(h){var m=h[0],v=h[1];return l(void 0,void 0,void 0,(function(){var h,w,p,y,g,E,A,N;return f(this,(function(S){return function(t){var e=t.querySelector("g[transform]");e.setAttribute("clip-path","url(#map-mask)");var r=document.createElementNS("http://www.w3.org/2000/svg","clipPath");r.setAttribute("id","map-mask"),r.setAttribute("fill","#FFFFFF"),e.appendChild(r)}(h=function(t){var e=document.querySelector("div#map-container");e.innerHTML=t;var r=e.querySelector("svg");return r.querySelector("rect").setAttribute("fill","#000000"),r}(m)),b(h),function(t){var e=t.querySelector("g[transform]"),r=e.getAttribute("transform"),n=document.createElementNS("http://www.w3.org/2000/svg","g");n.setAttribute("transform",r),n.setAttribute("id","avatar-layer"),e.insertAdjacentElement("afterend",n);var o=document.getElementById("avatar-icon").cloneNode(!0);o.setAttribute("id","avatar"),n.appendChild(o)}(h),w=function(c){var i=c.rects,s=c.notes,d=c.doors,l=i.map((function(e,r){return t({id:r},e)})),f=l.filter((function(t){return function(t){return 1===t.h&&1===t.w&&d.some((function(e){return e.x===t.x&&e.y===t.y}))}(t)})).map((function(e){return t({id:e.id},d.find((function(t){return t.x===e.x&&t.y===e.y})))})),h=function(t){return function(e){return t.find((function(t){return t.x===e.x&&t.y===e.y}))}}(f),m=l.filter((function(t){return!h(t)})).map((function(i){var d,f,m=function(t,e){return e.filter((function(e){return a(e,t)}))}(i,l).map((function(t){var n,u=h(t),c=function(t,e){return t?o(e)?a(e,t)?e.x===t.x-1?"west":e.x===t.x+t.w?"east":e.y===t.y-1?"north":e.y===t.y+t.h?"south":"UNKNOWN":(console.warn("Arguments to getDir are not adjacent: ".concat({from:e,to:t})),"UNKNOWN"):(console.warn("Unexpected argument to getDir ".concat(e)),"UNKNOWN"):"UNKNOWN"}(i,t);if(u){var s=l.find((function(e){return a(e,t)&&e.id!==i.id})),d=null!==(n=null==s?void 0:s.id)&&void 0!==n?n:"outside";return{towards:c,isFacing:e(u)===c,to:d,type:u.type,door:u,description:s?r(u,c,s):"way out of the dungeon"}}return{towards:c,to:t.id}})),v=h(i),w=null===(f=null===(d=s.filter((function(t){return u(t.pos,i)})))||void 0===d?void 0:d[0])||void 0===f?void 0:f.text,p=c.columns.filter((function(t){return u(t,i)})),y=c.water.filter((function(t){return u(t,i)})),g=function(t,e,r,o){var a=n(t,e),u=r&&r.length>0?t.rotunda?"- ".concat(r.length," columns ring the center of the room "):"- two rows of ".concat(Math.floor(r.length/2)," columns support the ceiling "):"",c=o&&o.length>0?o.length===t.h*t.w?"- water entirely covers the floor":"- water covers part of the floor (".concat(Math.floor(o.length/(t.h*t.w)*100),"%)"):"";return"".concat(a," ").concat(u).concat(c).trim()}(i,m,p,y);return t(t(t(t({id:i.id,description:g,area:i.rotunda?"".concat(i.h,"m across"):"".concat(i.w,"m x ").concat(i.h,"m")},w?{contains:w}:{}),i.ending?{ending:!0}:{}),v?{door:v}:{}),{exits:m,x:i.x,y:i.y,w:i.w,h:i.h})}));return t(t({},c),{rooms:m,doors:f,rects:l})}(v),q=document.querySelector("#map-container svg").querySelector("g[transform]").querySelector("g:nth-of-type(2)").querySelectorAll("path"),p=Array.from(q).slice(2),y=function(t){return function(e){var r="room-".concat(e);if(document.getElementById(r))return t[e];var n=t[e].getAttribute("d"),o=document.getElementById("map-mask");if(o){var a=document.createElementNS("http://www.w3.org/2000/svg","path");a.setAttribute("d",n),a.setAttribute("fill","#ff0000"),a.setAttribute("id",r),o.appendChild(a)}return t[e]}}(p),g=x(y),E=function(t){var e=function(t){return function(e){var r,n=c(c({},e),{error:void 0}),o=null===(r=t.rooms)||void 0===r?void 0:r.find((function(t){return t.id===n.id}));switch(n.action){case"east":case"west":case"north":case"south":var a=d(n),u=o.exits.filter(a).find((function(t){return t.towards===n.action}));return u?"outside"===u.to?c(c({},n),{message:"You leave the dungeon",end:!0}):c(c({},n),{id:u.to,message:"You go ".concat(n.action)}):c(c({},n),{message:"You cannot go that way"});case"search":var s=o.exits.find((function(t){return"secret door"===t.description}));if(s){var l=i(i([],n.discovered,!0),[{id:o.id,towards:s.towards}],!1);return c(c({},n),{discovered:l,message:"You discover a secret door to the ".concat(s.towards,"!")})}return c(c({},n),{message:"You find nothing of interest."});case"quit":return c(c({},n),{message:"You quit.",end:!0});default:return c(c({},n),{message:"Not understood.",error:"syntax"})}}}(t),r=s,n=function(t){return function(e){var r,n=null===(r=t.rooms)||void 0===r?void 0:r.find((function(t){return t.id===e}));if(!n)throw Error("Bad data: room ".concat(e," not found"));return n}}(t),o=function(t){return function(e){var r,n=t(e.id),o=d(e),a=n.exits.filter(o),u=a.reduce((function(t,e){return t+"To the ".concat(e.towards," is a ").concat(e.description)+"\n"}),"");return{description:"A ".concat(n.area," ").concat(n.description)+"\n"+"".concat(null!==(r=n.contains)&&void 0!==r?r:""," ")+"\n"+u,exits:a}}}(n),a=c(c({message:t.title+"\n"+t.story,room:r.id},o(r)),{end:!1});return function(t){if(r.turn>0){var n=function(t){switch(t){case"e":return"east";case"w":return"west";case"n":return"north";case"s":return"south";case"q":return"quit";case"x":return"search";default:return"unknown"}}(t);return r=e(c(c({},r),{action:n,turn:r.turn+1})),c(c({message:r.message,room:r.id},o(r)),{end:r.end,error:r.error})}if("INIT"!==t)throw new Error("The first call to the game must be 'INIT");return r=c(c({},r),{turn:1}),a}}(w),A=E("INIT"),g(A),N=function(){return l(void 0,void 0,void 0,(function(){var t,e,r,n;return f(this,(function(o){switch(o.label){case 0:return e=function(){return new Promise((function(e){t=function(t){var r,n=t.key.toLowerCase(),o=null!==(r={a:"w",w:"n",d:"e",s:"s",arrowup:"n",arrowdown:"s",arrowleft:"w",arrowright:"e"}[n])&&void 0!==r?r:n;e(o)},document.addEventListener("keydown",t,{once:!0})}))},[4,e()];case 1:return r=o.sent(),n=E(r),g(n),n.end?(document.removeEventListener("keydown",t),[2,n]):[2,N()]}}))}))},[2,N()];var q}))}))};v.addEventListener("click",(function(){return l(void 0,void 0,void 0,(function(){var t,e,r;return f(this,(function(n){switch(n.label){case 0:return t=document.getElementById("dungeon-select"),e=t.value,[4,m(e,p(w))];case 1:return r=n.sent(),[4,E(r)];case 2:return n.sent(),[2,(document.querySelector("section#game").classList.add("hide"),void document.querySelector("section#menu").classList.remove("hide"))]}}))}))}))})();